# Templates

Templates are written in Go's [`text/template`](http://golang.org/pkg/text/template/).

[[_TOC_]]

## Template Functions

### add

Adds two int values.

```text
{{add 1 3}}
```

### asJsonString

Converts the supplied value to a properly encoded JSON string.  For any value that is not currently of type string, `fmt.Sprintf("%v", value)` will be used to convert prior to encoding.  This should only be used on _leaf_ values.

```text
{{printf "{\"key\": %s}" (asJsonString (getv "/some/value"))}}
```

### atoi

Alias for the [strconv.Atoi](https://golang.org/pkg/strconv/#Atoi) function.

```text
{{seq 1 (atoi (getv "/count"))}}
```

### base

Alias for the [path.Base](https://golang.org/pkg/path/#Base) function.

```text
{{with get "/key"}}
    key: {{base .Key}}
    value: {{.Value}}
{{end}}
```

### base64Decode

Returns the string representing the decoded base64 value.

```text
key: {{base64Decode "VmFsdWU="}}
```

### base64Encode

Returns a base64 encoded string of the value.

```text
key: {{base64Encode "Value"}}
```

### cget

Returns the KVPair where key matches its argument and the value has been *encrypted*. Returns an error if key is not found.

```text
{{with cget "/key"}}
    key: {{.Key}}
    value: {{.Value}}
{{end}}
```

### cgets

Returns all KVPair, []KVPair, where key matches its argument and the values have been *encrypted*.
Returns an error if key is not found.

```text
{{range cgets "/*"}}
    key: {{.Key}}
    value: {{.Value}}
{{end}}
```

### cgetv

Returns the *encrypted* value as a string where key matches its argument. Returns an error if key is not found.

```text
value: {{cgetv "/key"}}
```

### cgetvs

Returns all *encrypted* values, []string, where key matches its argument. Returns an error if key is not found.

```text
{{range cgetvs "/*"}}
    value: {{.}}
{{end}}
```

### contains

Alias for [strings.Contains](https://golang.org/pkg/strings/#Contains)

```text
{{if contains "a long time ago" "time"}}{{"the world makes sense"}}{{end}}
```

### datetime

Alias for [time.Now](https://golang.org/pkg/time/#Now)

```text
# Generated by confd {{datetime}}
```

Outputs:

```text
# Generated by confd 2015-01-23 13:34:56.093250283 -0800 PST
```

```text
# Generated by confd {{datetime.Format "Jan 2, 2006 at 3:04pm (MST)"}}
```

Outputs:

```text
# Generated by confd Jan 23, 2015 at 1:34pm (EST)
```

See the time package for more usage: [http://golang.org/pkg/time/](http://golang.org/pkg/time/)

### dir

Returns the parent directory of a given key.

```text
{{with dir "/services/data/url"}}
dir: {{.}}
{{end}}
```

### div

Divides two int values.

```text
{{div 4 2}}
```

### escapeOsgi

Places a single `\` prior to any `'`, `"`, `\`, `=` or space.

```bash
$ clconf --pipe getv --template-string '{{escapeOsgi "foo=bar"}}' < /dev/null
foo\=bar
```

### exists

Checks if the key exists. Return false if key is not found.

```text
{{if exists "/key"}}
    value: {{getv "/key"}}
{{end}}
```

### fileExists

Checks if the file or directory at the specified filesystem path exists.

```text
{{if fileExists "/etc/myConfig"}}
    useConfig: /etc/myConfig
{{end}}
```

### fqdn

Adds a domain to a hostname if not already qualified.

```bash
$ clconf --pipe getv --template-string '{{fqdn "foo" "example.com"}}' < /dev/null
foo.example.com
$ clconf --pipe getv --template-string '{{fqdn "foo.google.com" "example.com"}}' < /dev/null
foo.google.com
```

### get

Returns the KVPair where key matches its argument. Returns an error if key is not found.

```text
{{with get "/key"}}
    key: {{.Key}}
    value: {{.Value}}
{{end}}
```

### getenv

Wrapper for [os.Getenv](https://golang.org/pkg/os/#Getenv). Retrieves the value of the environment variable named by the key. It returns the value, which will be empty if the variable is not present. Optionally, you can give a default value that will be returned if the key is not present.

```text
export HOSTNAME=`hostname`
```

```text
hostname: {{getenv "HOSTNAME"}}
```

#### getenv with a default value

```text
ipaddr: {{getenv "HOST_IP" "127.0.0.1"}}
```

### getksvs

Returns all values, []string, where key matches its argument, sorted by key. Optionally specify `int` to sort the values as integers. Returns an error if key is not found.

Preserve the order of list inputs:

```bash
$ clconf --pipe getv --template-string '{{getksvs "/foo/*" "int"}}' <<EOF
foo:
- dog
- bird
- cat
EOF
[dog bird cat]
```

Sort by string keys:

```console
$ clconf --pipe getv --template-string '{{getksvs "/foo/*"}}' <<EOF
foo:
  dog: woof
  bird: tweet
  cat: meow
EOF
[tweet meow woof]
```

### getsvs

Returns all values, []string, where key matches its argument, sorted. Optionally specify `int` to sort the values as integers. Returns an error if key is not found.

```bash
clconf --pipe getv --template-string '{{getsvs "/foo/*"}}' <<EOF
foo:
- dog
- bird
- cat
EOF
[bird cat dog]
```

### gets

Returns all KVPair, []KVPair, where key matches its argument. Returns an error if key is not found.

```text
{{range gets "/*"}}
    key: {{.Key}}
    value: {{.Value}}
{{end}}
```

### getv

Returns the value as a string where key matches its argument or an optional default value.
Returns an error if key is not found and no default value given.

```text
value: {{getv "/key"}}
```

#### With a default value

```text
value: {{getv "/key" "default_value"}}
```

### getvs

Returns all values, []string, where key matches its argument. Returns an error if key is not found.

```text
{{range getvs "/*"}}
    value: {{.}}
{{end}}
```

### join

Alias for the [strings.Join](https://golang.org/pkg/strings/#Join) function.

```text
{{$services := getvs "/services/elasticsearch/*"}}
services: {{join $services ","}}
```

### json

Returns an map[string]interface{} of the json value.

### jsonArray

Returns a []interface{} from a json array such as `["a", "b", "c"]`.

```text
{{range jsonArray (getv "/services/data/")}}
val: {{.}}
{{end}}
```

### lookupIP

Wrapper for [net.LookupIP](https://golang.org/pkg/net/#LookupIP) function. The wrapper also sorts (alphabeticaly) the IP addresses. This is crucial since in dynamic environments DNS servers typically shuffle the addresses linked to domain name. And that would cause unnecessary config reloads.

```text
{{range lookupIP "some.host.local"}}
    server {{.}};
{{end}}
```

### lookupIPV4

Same as `lookupIP` but filters down to IPV4 adresses.

### lookupIPV6

Same as `lookupIP` but filters down to IPV6 adresses.

### lookupSRV

Wrapper for [net.LookupSRV](https://golang.org/pkg/net/#LookupSRV). The wrapper also sorts the SRV records alphabetically by combining all the fields of the net.SRV struct to reduce unnecessary config reloads.

```text
{{range lookupSRV "mail" "tcp" "example.com"}}
  target: {{.Target}}
  port: {{.Port}}
  priority: {{.Priority}}
  weight: {{.Weight}}
{{end}}
```

### ls

Returns all subkeys, []string, where path matches its argument. Returns an empty list if path is not found.

```text
{{range ls "/deis/services"}}
   value: {{.}}
{{end}}
```

### lsdir

Returns all subkeys, []string, where path matches its argument. It only returns subkeys that also have subkeys. Returns an empty list if path is not found.

```text
{{range lsdir "/deis/services"}}
   value: {{.}}
{{end}}
```

### map

Creates a key-value map of string -> interface{}

```text
{{$endpoint := map "name" "elasticsearch" "private_port" 9200 "public_port" 443}}

name: {{index $endpoint "name"}}
private-port: {{index $endpoint "private_port"}}
public-port: {{index $endpoint "public_port"}}
```

specifically useful if you use a sub-template and you want to pass multiple values to it.

### mod

Modulus of two int values.

```text
{{mod 10 3}}
```

### parseBool

An alias to [`strconv.ParseBool`](https://golang.org/pkg/strconv/#ParseBool)

### regexReplace

Given a regex, an original string and a replacement string run [`regexp.ReplaceAllString`](https://golang.org/pkg/regexp/#Regexp.ReplaceAllString) and return the result. Returns an error if the regex fails to compile.

```bash
$ clconf --pipe getv --template-string '{{regexReplace "o+" "foo" "e"}}' < /dev/null
fe
```

### replace

Alias for the [strings.Replace](https://golang.org/pkg/strings/#Replace) function.

```text
{{$backend := getv "/services/backend/nginx"}}
backend = {{replace $backend "-" "_" -1}}
```

### reverse

Reverses a list.  If the list is `KVPair`, will compare keys, not values.

### seq

Alias for the [template.Seq](https://golang.org/pkg/template/#Seq) function.

### sort

Sorts the input ([]interface{}) by translating it to the specified type (one of `int`, `string`, default: `string`)

```bash
clconf --pipe getv --template-string '{{sort (getvs "/foo/*") }}' <<EOF
foo:
- dog
- bird
- cat
EOF
[bird cat dog]

clconf --pipe getv --template-string '{{ range $i := (sort (ls "/foo") "int")}}{{ getv (printf "/foo/%s" $i) }},{{ end }}' <<EOF
foo:
- dog
- bird
- cat
EOF
dog,bird,cat,
```

### sortByLength

Sorts a list of `string` values by their length.

### sortKvByLength

Sorts a list of `KVPair` values by the length of their key.

### split

Alias for [strings.Split](http://golang.org/pkg/strings/#Split). Splits the input string on the separating string and returns a slice of substrings.

```text
{{ $url := split (getv "/deis/service") ":" }}
    host: {{index $url 0}}
    port: {{index $url 1}}
```

### toLower

Alias for [strings.ToLower](http://golang.org/pkg/strings/#ToLower). Returns lowercased string.

```text
key: {{toLower "Value"}}
```

### toUpper

Alias for [strings.ToUpper](http://golang.org/pkg/strings/#ToUpper). Returns uppercased string.

```text
key: {{toUpper "value"}}
```

### trimSuffix

Alias for [strings.TrimSuffix](http://golang.org/pkg/strings/#TrimSuffix).

## Example Usage

Given the yaml input:

```yaml
---
nginx:
  domain: example.com
  root: /var/www/example_dotcom
  worker_processes: 2
app:
  upstream:
    app1: 10.0.1.100:80
    app2: 10.0.1.101:80
```

And the template:

```text
worker_processes {{getv "/nginx/worker_processes"}};

upstream app {
{{range getvs "/app/upstream/*"}}
    server {{.}};
{{end}}
}

server {
    listen 80;
    server_name www.{{getv "/nginx/domain"}};
    access_log /var/log/nginx/{{getv "/nginx/domain"}}.access.log;
    error_log /var/log/nginx/{{getv "/nginx/domain"}}.log;

    location / {
        root              {{getv "/nginx/root"}};
        index             index.html index.htm;
        proxy_pass        http://app;
        proxy_redirect    off;
        proxy_set_header  Host             $host;
        proxy_set_header  X-Real-IP        $remote_addr;
        proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;
    }
}
```

Output:

```text
worker_processes 2;

upstream app {
    server 10.0.1.100:80;
    server 10.0.1.101:80;
}

server {
    listen 80;
    server_name www.example.com;
    access_log /var/log/nginx/example.com.access.log;
    error_log /var/log/nginx/example.com.error.log;

    location / {
        root              /var/www/example_dotcom;
        index             index.html index.htm;
        proxy_pass        http://app;
        proxy_redirect    off;
        proxy_set_header  Host             $host;
        proxy_set_header  X-Real-IP        $remote_addr;
        proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;
    }
}
```

### Complex example

This examples show how to use a combination of the templates functions to do nested iteration.

```text
{{range $dir := lsdir "/services/web"}}
upstream {{base $dir}} {
    {{$custdir := printf "/services/web/%s/*" $dir}}{{range gets $custdir}}
    server {{$data := json .Value}}{{$data.IP}}:80;
    {{end}}
}

server {
    server_name {{base $dir}}.example.com;
    location / {
        proxy_pass {{base $dir}};
    }
}
{{end}}
```

Output:

```text
upstream cust1 {
    server 10.0.0.1:80;
    server 10.0.0.2:80;
}

server {
    server_name cust1.example.com;
    location / {
        proxy_pass cust1;
    }
}

upstream cust2 {
    server 10.0.0.3:80;
    server 10.0.0.4:80;
}

server {
    server_name cust2.example.com;
    location / {
        proxy_pass cust2;
    }
}
```

Go's [`text/template`](http://golang.org/pkg/text/template/) package is very powerful. For more details on it's capabilities see its [documentation.](http://golang.org/pkg/text/template/)
